<%
  require "date"
  def age(dob)
    now = Time.now.utc.to_date
    now.year - dob.year - ((now.month > dob.month || (now.month == dob.month && now.day >= dob.day)) ? 0 : 1)
  end
%>

<div class='container fix-footer'>
  <div class="d-flex">
     <div class="tree">
      <div id="inside-div">
        <ul>
          <li id='tree-width'>
            <div class='is-a-link'>
              <div class='avatar-inline'>
              <% @users.roots.each do |root| %>
                <%= link_to family_profile_path(root.family, root), class: 'not-link' do  %>
                  <% if root.photo.attached? %>
                    <div class='av-js' data-job='<%= root.job %>' data-firstname='<%= root.first_name %>' data-lastname='<%= root.last_name %>' data-birthdate='<%= root.birth_date %>'  data-age='%= age(root.birth_date) %>'>
                      <%= cl_image_tag root.photo.key, class: 'avatar-family' %>
                    </div>
                  <% else %>
                      <div class="avatar-family default av-js" data-job='<%= root.job %>' data-firstname='<%= root.first_name %>' data-lastname='<%= root.last_name %>' data-birthdate='<%= root.birth_date %>' data-age='<%= age(root.birth_date) %>' >
                        <%= root.first_name.first.upcase + root.last_name.first.upcase %>
                      </div>
                  <% end %>
                <%end%>
              <% end %>
              </div>
            </div>
            <ul>
              <% @users.select {|u| u.parent == @users.roots.where(direct_blood:true).first }.each do |child| %>
              <li>
                <div class='is-a-link'>
                  <div class='avatar-inline'>
                    <%= link_to family_profile_path(child.family, child), class: 'not-link' do  %>
                      <% if child.photo.attached? %>
                      <div class='av-js' data-job='<%= child.job %>' data-firstname='<%= child.first_name %>' data-lastname='<%= child.last_name %>' data-birthdate='<%= child.birth_date %>' data-age='<%= age(child.birth_date) %>'>
                          <%= cl_image_tag child.photo.key, class: 'avatar-family av-js' %>
                      </div>
                      <% else %>
                          <div class="avatar-family default av-js" data-job='<%= child.job %>' data-firstname='<%= child.first_name %>' data-lastname='<%= child.last_name %>' data-birthdate='<%= child.birth_date %>' data-age='<%= age(child.birth_date) %>' >
                            <%= child.first_name.first.upcase + child.last_name.first.upcase  %>
                          </div>
                      <% end %>
                    <% end %>
                    <% unless child.couple_out == [] %>
                      <%= link_to family_profile_path(child.family, child), class: 'not-link' do  %>
                        <% if child.couple_out.first.out_user.photo.attached? %>
                          <div class="av-js" data-job='<%= child.couple_out.first.out_user.job %>' data-firstname='<%= child.couple_out.first.out_user.first_name %>' data-lastname='<%= child.couple_out.first.out_user.last_name %>' data-birthdate='<%= child.couple_out.first.out_user.birth_date %>' data-age='<%= age(child.couple_out.first.out_user.birth_date) %>'>
                            <%= cl_image_tag child.couple_out.first.out_user.photo.key, class: 'avatar-family' %>
                          </div>
                        <% else %>
                            <div class="avatar-family default av-js" data-job='<%= child.couple_out.first.out_user.job %>' data-firstname='<%= child.couple_out.first.out_user.first_name %>' data-lastname='<%= child.couple_out.first.out_user.last_name %>' data-birthdate='<%= child.couple_out.first.out_user.birth_date %>' data-age='<%= age(child.couple_out.first.out_user.birth_date) %>'>
                              <%= child.couple_out.first.out_user.first_name.first.upcase + child.couple_out.first.out_user.last_name.first.upcase  %>
                            </div>
                        <% end %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
                <ul>
                  <% @users.select {|u| u.parent == child }.each_with_index do |grand_child, index| %>
                    <% if grand_child.couple_blood == [] %>
                      <li>
                        <%= link_to family_profile_path(grand_child.family, grand_child) do  %>
                          <div class='avatar-inline'>
                            <div>
                              <% if grand_child.photo.attached? %>
                                <div class="av-js" data-job='<%= grand_child.job %>' data-firstname='<%= grand_child.first_name %>' data-lastname='<%= grand_child.last_name %>' data-birthdate='<%= grand_child.birth_date %>' data-age='<%= age(grand_child.birth_date) %>'>
                                  <%= cl_image_tag grand_child.photo.key, class: 'avatar-family' %>
                                </div>
                              <% else %>
                                  <div class="avatar-family default av-js" data-job='<%= grand_child.job %>' data-firstname='<%= grand_child.first_name %>' data-lastname='<%= grand_child.last_name %>' data-birthdate='<%= grand_child.birth_date %>' data-age='<%= age(grand_child.birth_date) %>'>
                                    <%= grand_child.first_name.first.upcase + grand_child.last_name.first.upcase  %>
                                  </div>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      </li>
                    <% end %>
                  <% end %>
                </ul>
              </li>
              <% end %>
            </ul>
          </li>
        </ul>
      </div>
    </div>
    <div class='d-none box'>
    </div>
  </div>
    <div class="d-flex justify-content-start mt-2">
      <p id='zoom-out' class='blue-button-circle mr-2'>-</p>
      <p id='zoom-in' class='blue-button-circle mr-2'>+</p>
    </div>
 </div>

